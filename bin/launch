#!/usr/bin/env bash

#------------------------------------------------------------------------------
# Source helper functions
#------------------------------------------------------------------------------

source lib/misc.sh

#------------------------------------------------------------------------------
# Pull through image cache
#------------------------------------------------------------------------------

docker start registry-docker.io || docker run -d -p 5001:5000 \
  -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \
  --restart always \
  --name registry-docker.io \
  registry:2

#------------------------------------------------------------------------------
# Create k8s clusters
#------------------------------------------------------------------------------

multipass start kube-00 2>/dev/null || launch_k8s kube-00
multipass start kube-01 2>/dev/null || launch_k8s kube-01
multipass start kube-02 2>/dev/null || launch_k8s kube-02

#------------------------------------------------------------------------------
# Setup KUBECONFIG
#------------------------------------------------------------------------------

KUBECONFIG=~/.kube/config:tmp/kube-00/config:tmp/kube-01/config:tmp/kube-02/config \
kubectl config view --flatten > tmp/config && cp tmp/config ~/.kube/config

#------------------------------------------------------------------------------
# Setup ArgoCD
#------------------------------------------------------------------------------

ARGOCD_PASS=$(kubectl --context kube-00 -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d)
ARGOCD_IP=$(kubectl --context kube-00 -n argocd get svc argocd-server -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

[[ -n "${ARGOCD_PASS}" && -n "${ARGOCD_IP}" ]] || exit 1
argocd login ${ARGOCD_IP} --username admin --password ${ARGOCD_PASS} --insecure
argocd cluster add -y kube-01
argocd cluster add -y kube-02

#------------------------------------------------------------------------------
# Setup Istio with ArgoCD
#------------------------------------------------------------------------------

kubectl --context kube-00 apply -f ./conf/istio.yaml

# Base
argocd app sync kube-01-istio-base kube-02-istio-base
argocd app wait kube-01-istio-base kube-02-istio-base

# Cni
argocd app sync kube-01-istio-cni kube-02-istio-cni
argocd app wait kube-01-istio-cni kube-02-istio-cni

# Pilot
argocd app sync kube-01-istio-pilot kube-02-istio-pilot
argocd app wait kube-01-istio-pilot kube-02-istio-pilot

# IngressGateways
argocd app sync kube-01-istio-igws kube-02-istio-igws
argocd app wait kube-01-istio-igws kube-02-istio-igws

#------------------------------------------------------------------------------
#
#------------------------------------------------------------------------------

echo
echo "ArgoCD WebUI: https://${ARGOCD_IP}"
echo "ArgoCD User: admin"
echo "ArgoCD Pass: ${ARGOCD_PASS}"
