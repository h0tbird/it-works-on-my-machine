#!/usr/bin/env bash

#------------------------------------------------------------------------------
# Source helper functions
#------------------------------------------------------------------------------

source lib/misc.sh

#------------------------------------------------------------------------------
# Pull through image cache
#------------------------------------------------------------------------------

docker start registry-docker.io || docker run -d -p 5001:5000 \
  -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \
  --restart always \
  --name registry-docker.io \
  registry:2

#------------------------------------------------------------------------------
# Create k8s clusters
#------------------------------------------------------------------------------

multipass start kube-00 2>/dev/null || launch_k8s kube-00
multipass start kube-01 2>/dev/null || launch_k8s kube-01
multipass start kube-02 2>/dev/null || launch_k8s kube-02

#------------------------------------------------------------------------------
# Setup KUBECONFIG
#------------------------------------------------------------------------------

KUBECONFIG=~/.kube/config:tmp/kube-00/config:tmp/kube-01/config:tmp/kube-02/config \
kubectl config view --flatten > tmp/config && cp tmp/config ~/.kube/config
